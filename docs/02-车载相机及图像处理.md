
@[TOC](目录)

# 一、输入：相机+雷达 （10%）

1. 相机
1.1 车载相机使用概览
1.2 相机的成像原理
1.3 数字图像处理：去畸变、resize、颜色变换、转柱面、透视变换等（原理及源代码实现）
1.4 实现方案及性能分析：opencv、nvmedia
1.5 具体案例：车道线检测


## 1. 车载相机使用概览

![在这里插入图片描述](https://img-blog.csdnimg.cn/6874c7e7f37a4d1fa33e4b5b4639c95a.png)
![在这里插入图片描述](https://img-blog.csdnimg.cn/087d9ae170ce477e85f94ffb37cf91c8.png)
百度Apollo 硬件传感器方案

![在这里插入图片描述](https://img-blog.csdnimg.cn/d4b8f6b688a64ae9a8b66de6ebca3cfc.png)

轻舟QCraft硬件传感器方案


## 2. 相机的成像原理
![在这里插入图片描述](https://img-blog.csdnimg.cn/fc79d6c236734af1b3f5a0fa82c95d5a.png)

## 3. 车载摄像头重要指标参数

**摄像头信噪比、摄像头灵敏度、分辨率**

相应的性能设计中主要考虑如下因素：图像传输方式、输出分辨率、帧频、信噪比、动态范围、曝光控制、增益控制、白平衡、最低照度、镜头材质、镜头光学畸变、模组景深、模组视场角、额定工作电流、工作温度、存储温度、防护等级、外形尺寸、重量、功能安全等级、接插件/线束阻抗等。

![在这里插入图片描述](https://img-blog.csdnimg.cn/80ab7125b4e14924a25c0e0225b7627e.png)

具体来看，为应对复杂多样的使用环境，车载摄像头需要具备高动态性，其温度范围一般为-40 度~80 度，同时需要具备较高的防磁抗震性能，此外还需满足 8-10 年的基本使用寿命要求。性能方面，考虑到芯片处理负担，车载摄像头的像素要求较低，一般为100万-200 万像素，功率一般也在 10W 以下。

车载摄像头环境条件更为严苛，也相应具有更高的价值量。相较于传统的工业摄像头和手机摄像头，车载摄像头需要在高低温、湿热、强微光和振动等各种复杂工况条件下保持稳定的工作状态，因此车载摄像头具有更高的安全等级要求和工艺性能要求。考虑到安全因素，汽车厂商倾向于选择技术成熟、品质有保障的零部件厂商，因此车载零部件厂商进入市场体系获得评级需要更长的认证周期，行业壁垒较高。

![在这里插入图片描述](https://img-blog.csdnimg.cn/476f09d310ef40f586b9b6f24a50bebc.png)

### 相机模型中四个坐标系的关系

用一张图来直观表示四个坐标系之间空间的关系
![](https://img-blog.csdnimg.cn/img_convert/15e164049544918d42f8cd8d29215783.png)
图中，下标w表示的是世界坐标系，下标c表示的是相机坐标系，图中xoy为图像坐标系，uv为像素坐标系。

简单用语言描述四个坐标系之间的关系：世界坐标系通过平移和旋转得到相机坐标系。相机坐标系通过成像模型中的相似三角形原理得到图像坐标系。图像坐标系通过平移和缩放得到像素坐标系。

\参考：https://zhuanlan.zhihu.com/p/125006810

## 4. 车载摄像头的内外参标定

- 相机内参：与相机自身特性相关的参数，比如焦距、像素大小等
- 相机外参：相机在真实世界坐标系中的参数，比如相机的安装位置、旋转方向等


### 4.1 内参标定

1）内参矩阵（Sx,Sy,Cx,Cy,f）：代表相机的内部结构参数

参数说明：Sx和Sy代表相机芯片单个像素的物理尺寸Sx = 1/dx, Sy = 1/dy，单位是像素/毫米，一般情况下Sx=Sy，除非单个像素点在成像仪上是矩形而不是正方形。 Cx和Cy分别代表相机芯片的中心可能的偏移，这是因为芯片的安装通常无法绝对精准。 f代表相机的焦距，fx = f * Sx，fy=f * Sy。

2）畸变参数：k1,k2,k3径向畸变系数，p1,p2是切向畸变系数。（五个畸变参数，一般只需计算出k1,k2，p1,p2；对于鱼眼摄像头等径向畸变特别大的才需要计算出k3。）径向畸变发生在相机坐标系转图像物理坐标系的过程中；而切向畸变是发生在相机制作过程，其是由于感光元平面跟透镜不平行。

a、径向畸变：产生原因是光线在远离透镜中心的地方比靠近中心的地方更加弯曲，径向畸变主要包含桶形畸变和枕形畸变两种。

b、切向畸变：产生的原因透镜不完全平行于图像平面，这种现象发生于成像仪被粘贴在摄像机的时候。

3）内参的标定方式主要可以归为三类：传统的标定方法、基于主动视觉的标点以及自标定；目前常用的标定方法还是传统标定方法，比如张氏标定。

### 4.2 外参标定

相机外参数是相机的旋转矩阵R和平移向量t；旋转矩阵和平移矩阵共同描述了如何把点从世界坐标系转换到摄像机坐标系；

1）旋转矩阵：描述世界坐标系->相机坐标系的旋转变换

2）平移矩阵：描述世界坐标系->相机坐标系的平移变换

世界坐标系（world coordinate），也称为测量坐标系，是一个三维直角坐标系，以其为基准可以描述相机和待测物体的空间位置。世界坐标系的位置可以根据实际情况自由确定。

相机坐标系（camera coordinate），也是一个三维直角坐标系，原点位于镜头光心处，x、y轴分别与相面的两边平行，z轴为镜头光轴，与像平面垂直。


## 5. 相机基本图像处理

### 5.1 相机校正
当相机在现实世界中看到3D目标并将其转换为2D图像时，就会发生图像失真，这种转换并不完美。畸变实际上改变了这些3D物体的形状和大小。所以，分析相机图像的第一步，就是消除这种失真，这样你就能从中得到有用的信息。

![](https://img-blog.csdnimg.cn/img_convert/3e604916ee4954fb43103026a14a8f24.webp?x-oss-process=image/format,png)

有两种类型的畸变我们感兴趣：径向畸变和切向畸变。

为了校准相机，我们可以拍摄已知形状的照片并校正失真误差。这个任务最常见的拍摄对象是棋盘，因为它具有高对比度图案。
首先，我们需要使用我们的相机来拍摄大量的棋盘图像，并检测这些图像中的所有角点。这可以使用OpenCV的 ``cv2.findChessboardCorners()``函数来完成。

![](https://img-blog.csdnimg.cn/img_convert/cdb4b404053dcc6fe83124ebf345ee18.webp?x-oss-process=image/format,png)

``cv2.findChessboardCorners()``的结果 
 
在这之后，我们使用cv2.calibrateCamera()来计算畸变系数。径向畸变有3个系数：k1, k2, k3 ，切向畸变有2个系数：p1, p2。畸变点坐标计算公式如下，其中r为未畸变图像中某一点到图像畸变中心的已知距离，畸变中心通常是该图像的中心(x_c, y_c)

径向畸变公式  
![](https://img-blog.csdnimg.cn/img_convert/010d92c2db9413ac2a59765d13bedc41.webp?x-oss-process=image/format,png)
切向畸变公式  
![](https://img-blog.csdnimg.cn/img_convert/88244e1f3a621b715659d3e0c6dcb3e6.webp?x-oss-process=image/format,png)

畸变校正之后的结果  

![](https://img-blog.csdnimg.cn/img_convert/4b4c2ba4022b6c4c9120bf79f413ee8e.webp?x-oss-process=image/format,png)

![](https://img-blog.csdnimg.cn/img_convert/815abe3eac37899018ab7f6c24477cb3.webp?x-oss-process=image/format,png)

### 5.2 透视变换
在这一步，我们将图像转换为鸟瞰图。它将使以后的步骤，如测量车道曲率更容易。要变换图像，我们首先需要从源图像上和目标图像上分别得到4个点，并使用函数cv2.getPerspectiveTransform()。当我们想通过cv2.warpPerspective()函数变换图像时，该函数计算一个出一个3x3的变换矩阵。

![](https://img-blog.csdnimg.cn/img_convert/3c991665eea17ae46b94ac92dd88a509.webp?x-oss-process=image/format,png)
透视变换之前和之后的图像  

### 5.3 颜色阈值和区域掩码
![](https://img-blog.csdnimg.cn/img_convert/92997e4a4ffe5794fa3e008c32ea852e.webp?x-oss-process=image/format,png)
HSV 和 HLS 颜色空间  

HLS(色调，亮度，饱和度)是RGB模型的一种替代表示。HLS是圆柱形几何图形，具有色相，角度维度，是实际的颜色。亮度表示颜色中混合了多少白色(或黑色)的颜色，饱和度表示颜色中有多少灰色。饱和度值为0，表示大部分都是灰色。
车道线的颜色为白色和黄色，两者都有一定范围内的饱和度值。因此，我只选择饱和度值在该范围内的像素。此外，利用亮度通道过滤掉所有亮度值较小的像素，可以检测出白色。


![](https://img-blog.csdnimg.cn/img_convert/16ec390eff4c0157d1cc863909ec8886.webp?x-oss-process=image/format,png)
Hue, 亮度和饱和度值  

区域掩码是去除图像中不太可能包含线的部分的过程。我们可以看到，车道线主要出现在图片的下半部，因此，可以将图像的上半部分像素屏蔽以增加我们的准确性，因为图像现在只包含那些更加可能是车道线的部分。


### 5.4 图像变换（原理及源代码实现）
- 颜色变换
- resize
- 转柱面
- 透视变换等


## 6.  实现方案及性能分析：opencv、nvmedia


## 7.  具体案例：车道线检测


